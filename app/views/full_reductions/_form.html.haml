= form_for @full_reduction, :remote => true do |f|
  - if @full_reduction.errors.any?
    #error_explanation
      %h2= "#{pluralize(@full_reduction.errors.count, "error")} prohibited this full_reduction from being saved:"
      %ul
        - @full_reduction.errors.full_messages.each do |msg|
          %li= msg
  .field
    = f.hidden_field :preferential_way
    = hidden_field_tag "selectProductHash", @selectProductHashStr
    = hidden_field_tag "giftSelectProductHash", @giftSelectProductHashStr
    = hidden_field_tag "selectCouponHash", @selectCouponHashStr
  %h4.col-sm-offset-1 设置满减送
  .hr.hr-16.hr-dotted
  .form-group{:style => "height: 240px; margin-bottom: 10px;"}
    %img.col-sm-10.col-sm-offset-2{:id => 'avatar_img', :style => "width: 600px; height: 240px;"}
  .form-group
    = f.label t(:avatar, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right" 
    .col-sm-10
      = f.collection_select :avatar, @promotionImages, :avatar, :title, :prompt => "请选择图片模版", :class => 'form-control'
  .form-group
    = f.label t(:name, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right"
    .col-sm-10
      = f.text_field :name, :class => "col-sm-5"
  - if '4' != @full_reduction.preferential_way
    .form-group
      = f.label t(:quota, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right"
      .col-sm-10
        = f.text_field :quota, :class => "col-sm-5"
  - if '1' == @full_reduction.preferential_way
    .form-group
      = f.label t(:reduction, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right"
      .col-sm-10
        = f.text_field :reduction, :class => "col-sm-5"
  - if '2' == @full_reduction.preferential_way
    .form-group
      = f.label t(:integral, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right"
      .col-sm-10
        = f.text_field :integral, :class => "col-sm-5"
  - if '4' == @full_reduction.preferential_way
    .form-group
      = f.label t(:purchase_quantity, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right"
      .col-sm-10
        = f.text_field :purchase_quantity, :class => "col-sm-5"
  .form-group
    = f.label "", t(:start_time, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right"
    .col-sm-10
      = f.text_field :start_time, {:id => "datetimepicker_start_time", :type => "text"}
    :javascript
      $(function () {
        $('#datetimepicker_start_time').datetimepicker({
          sideBySide: true,
          locale: "zh-cn",
          format: "YYYY-MM-DD HH:mm"
        });
      });
  .form-group
    = f.label "", t(:end_time, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right"
    .col-sm-10
      = f.text_field :end_time, {:id => "datetimepicker_end_time", :type => "text"}
    :javascript
      $(function () {
        $('#datetimepicker_end_time').datetimepicker({
          sideBySide: true,
          locale: "zh-cn",
          format: "YYYY-MM-DD HH:mm"
        });
      });
  .form-group
    = f.label t(:tag, scope: "mongoid.attributes.FullReduction") + ":", :class => "col-sm-2 control-label no-padding-right"
    .col-sm-10
      = f.text_field :tag, :placeholder => "该标签打在参与的商品", :class => "col-sm-5"
  - if '3' == @full_reduction.preferential_way
    .form-group
      = label_tag "", "选择优惠券:", :class => "col-sm-2 control-label no-padding-right"
      .col-sm-10
        .tabbable{:id => "divCoupons"}
          %ul{:id => "couponsTab", :class => "nav nav-tabs"}
            %li{:class => "active"}
              %a{:href => "#coupons", "data-toggle" => "tab"}选择优惠券
            %li
              %a{:href => "#selectCoupons", "data-toggle" => "tab"}已选优惠券
          .tab-content
            .tab-pane.in.active{:id => "coupons"}
              %table{:class => "table table-striped table-bordered table-hover", :id => "couponsTable"}
                %thead
                  %tr
                    %th= t(:title, scope: "mongoid.attributes.Coupon")
                    %th= t(:quantity, scope: "mongoid.attributes.Coupon")
                    %th= t(:value, scope: "mongoid.attributes.Coupon")
                    %th= t(:limit, scope: "mongoid.attributes.Coupon")
                    %th= t(:start_time, scope: "mongoid.attributes.Coupon")
                    %th= t(:end_time, scope: "mongoid.attributes.Coupon")
                    %th= t(:order_amount, scope: "mongoid.attributes.Coupon")
                    %th= t(:use_goods, scope: "mongoid.attributes.Coupon")
                    %th= t(:buy_limit, scope: "mongoid.attributes.Coupon")
                    %th= t(:gifts_quantity, scope: "mongoid.attributes.FullReduction")
                    %th= t '.actions', :default => t("helpers.actions")
                %tbody
                  - @coupons.each do |coupon|
                    %tr{:class => "cls_#{coupon.id}"}
                      %td= coupon.title
                      %td= coupon.quantity
                      %td= coupon.value
                      %td= coupon.limit
                      %td= coupon.startTimeShow
                      %td= coupon.endTimeShow
                      %td= "0" == coupon.order_amount_way ? "无限制" : coupon.order_amount
                      %td= "0" == coupon.use_goods ? "全店能用" : "指定商品"
                      %td= coupon.buy_limit ? "仅原价购买商品时可用" : "不限制"
                      %td
                        %input{:type => "number", :id => "quantity_#{coupon.id}", :value => "#{@selectCouponHash[coupon.id.to_s]}"}
                      %td
                        - if @couponIds.include?(coupon.id.to_s)
                          %button{:type => "button", :class => "btn", :id => "#{coupon.id}_attend", :onclick => "attendActivity('#{coupon.id}', false, true)", :disabled => "true"}已参加
                        - else
                          %button{:type => "button", :class => "btn btn-primary", :id => "#{coupon.id}_attend", :onclick => "attendActivity('#{coupon.id}', false, true)"}参加赠品
            .tab-pane{:id => "selectCoupons"}
              %table{:class => "table table-striped table-bordered table-hover", :id => "couponSelectedTable"}
                %thead
                  %tr
                    %th= t(:title, scope: "mongoid.attributes.Coupon")
                    %th= t(:quantity, scope: "mongoid.attributes.Coupon")
                    %th= t(:value, scope: "mongoid.attributes.Coupon")
                    %th= t(:limit, scope: "mongoid.attributes.Coupon")
                    %th= t(:start_time, scope: "mongoid.attributes.Coupon")
                    %th= t(:end_time, scope: "mongoid.attributes.Coupon")
                    %th= t(:order_amount, scope: "mongoid.attributes.Coupon")
                    %th= t(:use_goods, scope: "mongoid.attributes.Coupon")
                    %th= t(:buy_limit, scope: "mongoid.attributes.Coupon")
                    %th= t(:gifts_quantity, scope: "mongoid.attributes.FullReduction")
                    %th= t '.actions', :default => t("helpers.actions")
                %tbody
                  - @full_reduction.coupons.each do |coupon|
                    %tr{:class => "cls_#{coupon.id}"}
                      %td= coupon.title
                      %td= coupon.quantity
                      %td= coupon.value
                      %td= coupon.limit
                      %td= coupon.start_time
                      %td= coupon.end_time
                      %td= "0" == coupon.order_amount_way ? "无限制" : coupon.order_amount
                      %td= "0" == coupon.use_goods ? "全店能用" : "指定商品"
                      %td= coupon.buy_limit ? "仅原价购买商品时可用" : "不限制"
                      %td
                        %input{:type => "number", :id => "quantity_#{coupon.id}", :value => "#{@selectCouponHash[coupon.id.to_s]}"}
                      %td
                        %button{:type => "button", :class => "btn btn-primary", :id => "#{coupon.id}_cancel", :onclick => "cancelActivity('#{coupon.id}')"}取消参加
  - if '4' == @full_reduction.preferential_way || '5' == @full_reduction.preferential_way
    .form-group
      = label_tag "", "选择赠品:", :class => "col-sm-2 control-label no-padding-right"
      .col-sm-10
        .tabbable{:id => "divProducts"}
          %ul{:id => "myTab", :class => "nav nav-tabs"}
            %li{:class => "active"}
              %a{:href => "#giftProducts", "data-toggle" => "tab"}选择商品
            %li
              %a{:href => "#giftSelectProducts", "data-toggle" => "tab"}已选商品
          .tab-content
            .tab-pane.in.active{:id => "giftProducts"}
              %table{:class => "table table-striped table-bordered table-hover", :id => "giftTableProducts"}
                %thead
                  %tr
                    %th= t(:thumbnail, scope: "mongoid.attributes.product")
                    %th= t(:title, scope: "mongoid.attributes.product")
                    %th= t(:price, scope: "mongoid.attributes.product")
                    %th= t(:stock, scope: "mongoid.attributes.product")
                    %th= t(:gifts_quantity, scope: "mongoid.attributes.FullReduction")
                    %th= t '.actions', :default => t("helpers.actions")
                %tbody
                  - @giftProducts.each do |product|
                    %tr{:class => "cls_#{product.id}"}
                      %td
                        %img.product-img{:src => "#{RestConfig::IMG_SERVER + product.avatar_url}"}
                      %td= product.title
                      %td= format("%.2f", product.price).to_f
                      %td= product.stock
                      %td
                        %input{:type => "number", :id => "gifts_quantity_#{product.id}", :value => "#{@giftSelectProductHash[product.id.to_s]}"}
                      %td
                        - if @giftsProductId.include?(product.id.to_s)
                          %button{:type => "button", :class => "btn", :id => "gift_#{product.id}_attend", :onclick => "attendActivity('#{product.id}', true)", :disabled => "true"}已参加
                        - else
                          %button{:type => "button", :class => "btn btn-primary", :id => "gift_#{product.id}_attend", :onclick => "attendActivity('#{product.id}', true)"}参加赠品
            .tab-pane{:id => "giftSelectProducts"}
              %table{:class => "table table-striped table-bordered table-hover", :id => "giftSelectedProductsTable"}
                %thead
                  %tr
                    %th= t(:thumbnail, scope: "mongoid.attributes.product")
                    %th= t(:title, scope: "mongoid.attributes.product")
                    %th= t(:price, scope: "mongoid.attributes.product")
                    %th= t(:stock, scope: "mongoid.attributes.product")
                    %th= t(:gifts_quantity, scope: "mongoid.attributes.FullReduction")
                    %th= t '.actions', :default => t("helpers.actions")
                %tbody
                  - @full_reduction.gifts(current_user).each do |product|
                    %tr{:class => "cls_#{product.id}"}
                      %td
                        %img.product-img{:src => "#{RestConfig::IMG_SERVER + product.avatar_url}"}
                      %td= product.title
                      %td= format("%.2f", product.price).to_f
                      %td= product.stock
                      %td
                        %input{:type => "number", :id => "gifts_quantity_#{product.id}", :value => "#{@giftSelectProductHash[product.id.to_s]}"}
                      %td
                        %button{:type => "button", :class => "btn btn-primary", :id => "gift_#{product.id}_cancel", :onclick => "cancelActivity('#{product.id}', true)"}取消参加
  .form-group
    = label_tag "", "选择活动商品:", :class => "col-sm-2 control-label no-padding-right"
    .col-sm-10
      = radio_button_tag "product_select", "0", "0" == @full_reduction.use_goods, class: "cls_use_goods"
      全部商品参与
      %br
      = radio_button_tag "product_select", "1", "1" == @full_reduction.use_goods, class: "cls_use_goods"
      部分商品参与
      .tabbable{:id => "divProducts"}
        %ul{:id => "myTab", :class => "nav nav-tabs"}
          %li{:class => "active"}
            %a{:href => "#home", "data-toggle" => "tab"}选择商品
          %li
            %a{:href => "#profile", "data-toggle" => "tab"}已选商品
        .tab-content
          .tab-pane.in.active{:id => "home"}
            %table{:class => "table table-striped table-bordered table-hover", :id => "tableProducts"}
              %thead
                %tr
                  %th= t(:thumbnail, scope: "mongoid.attributes.product")
                  %th= t(:qrcode, scope: "mongoid.attributes.product")
                  %th= t(:title, scope: "mongoid.attributes.product")
                  %th= t(:price, scope: "mongoid.attributes.product")
                  %th= t(:stock, scope: "mongoid.attributes.product")
                  %th= t '.actions', :default => t("helpers.actions")
              %tbody
                - @products.each do |product|
                  %tr{:class => "cls_#{product.id}"}
                    %td
                      %img.product-img{:src => "#{RestConfig::IMG_SERVER + product.avatar_url}"}
                    %td= product.qrcode
                    %td= product.title
                    %td= format("%.2f", product.price).to_f
                    %td= product.stock
                    %td
                      - if @full_reduction.participate_product_ids.include?(product.id.to_s)
                        %button{:type => "button", :class => "btn", :id => "#{product.id}_attend", :onclick => "attendActivity('#{product.id}', false)", :disabled => "true"}已参加
                      - else
                        %button{:type => "button", :class => "btn btn-primary", :id => "#{product.id}_attend", :onclick => "attendActivity('#{product.id}', false)"}参加活动
          .tab-pane{:id => "profile"}
            %table{:class => "table table-striped table-bordered table-hover", :id => "selectedProductsTable"}
              %thead
                %tr
                  %th= t(:thumbnail, scope: "mongoid.attributes.product")
                  %th= t(:qrcode, scope: "mongoid.attributes.product")
                  %th= t(:title, scope: "mongoid.attributes.product")
                  %th= t(:price, scope: "mongoid.attributes.product")
                  %th= t(:stock, scope: "mongoid.attributes.product")
                  %th= t '.actions', :default => t("helpers.actions")
              %tbody
                - @full_reduction.participateProducts(current_user).each do |product|
                  %tr{:class => "cls_#{product.id}"}
                    %td
                      %img.product-img{:src => "#{RestConfig::IMG_SERVER + product.avatar_url}"}
                    %td= product.qrcode
                    %td= product.title
                    %td= format("%.2f", product.price).to_f
                    %td= product.stock
                    %td
                      %button{:type => "button", :class => "btn btn-primary", :id => "#{product.id}_cancel", :onclick => "cancelActivity('#{product.id}', false)"}取消参加
  .form-actions
    .col-md-offset-3.col-md-9
      %button{:class => "btn btn-info"}
        %i{:class => "ace-icon fa fa-check bigger-110"}
        保存
      %button{:class => "btn", :type => "reset"}
        %i{:class => "ace-icon fa fa-undo bigger-110"}
        重置
      %button{:class => "btn", :type => "button", :onclick => "location.hash='##{full_reductions_path}?preferential_way=#{@full_reduction.preferential_way}|hash#{rand(1000)}'"}
        %i{:class => "ace-icon fa fa-reply bigger-110"}
        取消
:javascript
  $(document).ready(function () {
      fullReduction();
  });